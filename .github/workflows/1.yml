name: Build PanVk for G610

on:
  push:
    branches: [main, panvk-android]
  workflow_dispatch:

jobs:
  build:
    name: "Build PanVk for aarch64 (G610)"
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y ninja-build pkg-config \
            libxrandr-dev libxxf86vm-dev libxcb-*-dev \
            libx11-xcb-dev libxfixes-dev libdrm-dev libx11-dev \
            python3-pip wget unzip gettext
          pip3 install --upgrade meson mako
          meson --version

      - name: Setup Android NDK
        run: |
          wget -q https://dl.google.com/android/repository/android-ndk-r25c-linux.zip
          unzip -q android-ndk-r25c-linux.zip
          echo "ANDROID_NDK_HOME=$(pwd)/android-ndk-r25c" >> $GITHUB_ENV

      - name: Build libdrm
        run: |
          # 创建 DRM 交叉编译文件
          echo '[binaries]' > build-crossfile-drm
          echo "ar = '$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ar'" >> build-crossfile-drm
          echo "c = ['$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android26-clang', '-O3', '-DVK_USE_PLATFORM_ANDROID_KHR', '-fPIC']" >> build-crossfile-drm
          echo "cpp = ['$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android26-clang++', '-O3', '-DVK_USE_PLATFORM_ANDROID_KHR', '-fPIC', '-fno-exceptions', '-fno-unwind-tables', '-fno-asynchronous-unwind-tables', '-static-libstdc++']" >> build-crossfile-drm
          echo "c_ld = 'lld'" >> build-crossfile-drm
          echo "cpp_ld = 'lld'" >> build-crossfile-drm
          echo "strip = '$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-strip'" >> build-crossfile-drm
          echo "pkg-config = ['env', 'PKG_CONFIG_LIBDIR=.', '/usr/bin/pkg-config']" >> build-crossfile-drm
          echo '' >> build-crossfile-drm
          echo '[host_machine]' >> build-crossfile-drm
          echo "system = 'linux'" >> build-crossfile-drm
          echo "cpu_family = 'arm'" >> build-crossfile-drm
          echo "cpu = 'armv8'" >> build-crossfile-drm
          echo "endian = 'little'" >> build-crossfile-drm

          git clone --depth 1 https://gitlab.freedesktop.org/mesa/drm.git
          cd drm
          meson setup "build-android" \
            --prefix=/tmp/drm-static \
            --cross-file "../build-crossfile-drm" \
            -Ddefault_library=static \
            -Dintel=disabled \
            -Dradeon=disabled \
            -Damdgpu=disabled \
            -Dnouveau=disabled \
            -Dvmwgfx=disabled \
            -Dfreedreno=disabled \
            -Dvc4=disabled \
            -Detnaviv=disabled
          ninja -C "build-android" install

      - name: Build Mesa with PanVk for G610
        run: |
          # 创建 Mesa 交叉编译文件
          echo '[binaries]' > build-crossfile
          echo "ar = '$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ar'" >> build-crossfile
          echo "c = ['$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android26-clang', '-O3', '-DVK_USE_PLATFORM_ANDROID_KHR', '-fPIC']" >> build-crossfile
          echo "cpp = ['$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android26-clang++', '-O3', '-DVK_USE_PLATFORM_ANDROID_KHR', '-fPIC', '-fno-exceptions', '-fno-unwind-tables', '-fno-asynchronous-unwind-tables', '-static-libstdc++']" >> build-crossfile
          echo "c_ld = 'lld'" >> build-crossfile
          echo "cpp_ld = 'lld'" >> build-crossfile
          echo "strip = '$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-strip'" >> build-crossfile
          echo "pkg-config = ['env', 'PKG_CONFIG_LIBDIR=.:/tmp/drm-static/lib/pkgconfig', '/usr/bin/pkg-config']" >> build-crossfile
          echo '' >> build-crossfile
          echo '[host_machine]' >> build-crossfile
          echo "system = 'linux'" >> build-crossfile
          echo "cpu_family = 'arm'" >> build-crossfile
          echo "cpu = 'armv8'" >> build-crossfile
          echo "endian = 'little'" >> build-crossfile

          # 克隆 Mesa 并使用正确的标签
          git clone https://gitlab.freedesktop.org/mesa/mesa.git
          cd mesa
          git checkout mesa-25.3.0
          git config advice.detachedHead false

          export PATH="$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin:$PATH"

          # 配置 Mesa 构建 - 彻底禁用 OpenCL 和 CLC
          meson setup "build-android" \
            --prefix=/tmp/pan \
            --cross-file "../build-crossfile" \
            -Dplatforms=android \
            -Dplatform-sdk-version=26 \
            -Dandroid-stub=true \
            -Dvulkan-drivers=panfrost \
            -Dgallium-drivers= \
            -Dshared-glapi=disabled \
            -Dopencl=disabled \
            -Dgallium-opencl=disabled \
            -Dbuildtype=release

          ninja -C "build-android" install

      - name: Package and optimize for G610
        run: |
          cd mesa/build-android
          
          echo "Built libraries:"
          find . -name "*.so" -type f | head -20
          
          # 创建针对 G610 的优化包
          mkdir -p g610-package/system/lib64
          mkdir -p g610-package/system/vendor/lib64/hw
          
          # 复制 PanVk 驱动
          if [ -f "src/panfrost/vulkan/libvulkan_panfrost.so" ]; then
            cp src/panfrost/vulkan/libvulkan_panfrost.so g610-package/system/lib64/
            cp src/panfrost/vulkan/libvulkan_panfrost.so g610-package/system/vendor/lib64/hw/vulkan.panfrost.so
            echo "Found and copied libvulkan_panfrost.so for G610"
          else
            find . -name "libvulkan_panfrost.so" -type f -exec cp {} g610-package/system/lib64/ \;
            find . -name "libvulkan_panfrost.so" -type f -exec cp {} g610-package/system/vendor/lib64/hw/vulkan.panfrost.so \;
            echo "Copied libvulkan_panfrost.so via search for G610"
          fi
          
          # 验证文件
          if ls g610-package/system/lib64/*.so >/dev/null 2>&1; then
            echo "G610 build successful!"
            ls -la g610-package/system/lib64/
            file g610-package/system/lib64/*.so
          else
            echo "Error: No shared libraries found for G610"
            exit 1
          fi
          
          # 创建 G610 专用安装包
          cd g610-package
          tar -czf ../../panvk-g610-25.3.0-$(date +%Y%m%d).tar.gz system/

      - name: Upload G610 artifacts
        uses: actions/upload-artifact@v4
        with:
          name: panvk-g610-25.3.0
          path: |
            mesa/panvk-g610-*.tar.gz
            mesa/build-android/g610-package/system/lib64/*.so
          retention-days: 30
