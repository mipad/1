name: Build PanVk for Mali-G610

on:
  push:
    branches: [ main, panvk-android ]
  workflow_dispatch:

env:
  NDK_VERSION: 'r25c'
  BUILD_TYPE: 'release'

jobs:
  build-panvk:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout workflow files
      uses: actions/checkout@v4
      
    - name: Setup build environment
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          python3 python3-pip ninja-build pkg-config \
          libdrm-dev libelf-dev gettext bison flex \
          wget unzip git cmake make
        
    - name: Install latest Meson
      run: |
        # 安装最新版本的Meson
        pip3 install --upgrade pip
        pip3 install meson mako
        meson --version
        
    - name: Download Android NDK
      run: |
        # 使用更新的NDK版本
        wget -q https://dl.google.com/android/repository/android-ndk-${{ env.NDK_VERSION }}-linux.zip
        unzip -q android-ndk-${{ env.NDK_VERSION }}-linux.zip
        echo "NDK_HOME=$(pwd)/android-ndk-${{ env.NDK_VERSION }}" >> $GITHUB_ENV
        
    - name: Verify NDK tools
      run: |
        echo "Checking NDK toolchain..."
        ls -la $NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/ | grep aarch64 | head -10
        # 检查关键工具是否存在
        $NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android21-clang --version || echo "Clang not found"
        
    - name: Clone Mesa repository
      run: |
        git clone https://gitlab.freedesktop.org/mesa/mesa.git mesa-src
        cd mesa-src
        
        # 尝试不同的版本格式
        git checkout 25.3.0 || git checkout mesa-25.3.0
        
    - name: Configure PanVk build for G610
      run: |
        cd mesa-src
        
        # 创建正确的交叉编译配置文件
        cat > android-cross.txt << 'EOF'
        [binaries]
        c = 'aarch64-linux-android21-clang'
        cpp = 'aarch64-linux-android21-clang++'
        ar = 'aarch64-linux-android-ar'
        strip = 'aarch64-linux-android-strip'
        pkg-config = 'pkg-config'

        [host_machine]
        system = 'linux'
        cpu_family = 'aarch64'
        cpu = 'aarch64'
        endian = 'little'
        EOF
        
        # 设置环境变量
        export PATH="$NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin:$PATH"
        
        # 配置Mesa构建 - 修复选项
        meson setup build-android \
          --cross-file android-cross.txt \
          -Dplatforms=android \
          -Dvulkan-drivers=panfrost \
          -Dgallium-drivers= \
          -Dandroid-stub=true \
          -Dshader-cache=enabled \
          -Dglx=disabled \
          -Degl=disabled \
          -Dgles1=disabled \
          -Dgles2=disabled \
          -Dopengl=false \
          -Dvulkan-beta=true \
          -Dvalgrind=disabled \
          -Dlibunwind=disabled \
          -Dlmsensors=disabled \
          -Dbuildtype=${{ env.BUILD_TYPE }} \
          -Db_ndebug=true \
          -Dcpp_rtti=true \
          -Db_lto=false \
          -Dprefix=/system
        
    - name: Build PanVk driver
      run: |
        cd mesa-src/build-android
        export PATH="$NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin:$PATH"
        ninja -j$(nproc --all)
        
    - name: Extract and package artifacts
      run: |
        cd mesa-src/build-android
        
        # 查找生成的库文件
        find . -name "*.so" -type f | head -10
        
        # 创建输出目录
        mkdir -p output/system/lib64
        mkdir -p output/system/vendor/lib64/hw
        
        # 复制PanVk驱动
        if [ -f "src/panfrost/vulkan/libvulkan_panfrost.so" ]; then
          cp src/panfrost/vulkan/libvulkan_panfrost.so output/system/lib64/
          echo "Found libvulkan_panfrost.so in standard location"
        elif find . -name "libvulkan_panfrost.so" -type f | head -1; then
          find . -name "libvulkan_panfrost.so" -type f -exec cp {} output/system/lib64/ \;
          echo "Found libvulkan_panfrost.so via search"
        else
          echo "Warning: libvulkan_panfrost.so not found"
          # 列出所有so文件用于调试
          find . -name "*.so" -type f
          # 尝试其他可能的路径
          find src/ -name "*.so" -type f -exec cp {} output/system/lib64/ \; 2>/dev/null || true
        fi
        
        # 验证文件
        if ls output/system/lib64/*.so >/dev/null 2>&1; then
          echo "Build successful! Found libraries:"
          ls -la output/system/lib64/
          file output/system/lib64/*.so
        else
          echo "Error: No shared libraries found"
          exit 1
        fi
        
        # 创建简单的安装包
        cd output
        tar -czf ../panvk-g610-$(date +%Y%m%d).tar.gz system/
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: panvk-g610-driver
        path: |
          mesa-src/build-android/panvk-g610-*.tar.gz
          mesa-src/build-android/output/system/lib64/*.so
        retention-days: 30
