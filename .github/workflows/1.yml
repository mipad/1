name: Build PanVk for G610

on:
  push:
    branches: [main, panvk-android]
  workflow_dispatch:

jobs:
  build:
    name: "Build PanVk for aarch64 (G610)"
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y ninja-build pkg-config \
            libxrandr-dev libxxf86vm-dev libxcb-*-dev \
            libx11-xcb-dev libxfixes-dev libdrm-dev libx11-dev \
            python3-pip wget unzip gettext git
          pip3 install --upgrade meson mako

      - name: Setup Android NDK
        run: |
          wget -q https://dl.google.com/android/repository/android-ndk-r25c-linux.zip
          unzip -q android-ndk-r25c-linux.zip
          echo "ANDROID_NDK_HOME=$(pwd)/android-ndk-r25c" >> $GITHUB_ENV
          echo "NDK_TOOLCHAIN=$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64" >> $GITHUB_ENV

      - name: Build Android dependencies (cutils and others)
        run: |
          # 创建必要的依赖目录
          mkdir -p /tmp/android-deps/lib/pkgconfig
          mkdir -p /tmp/android-deps/include
          
          # 创建简化版 cutils 头文件
          cat << 'EOF' > /tmp/android-deps/include/cutils/android_reboot.h
          /* Simplified cutils header for Mesa build */
          #ifndef CUTILS_ANDROID_REBOOT_H
          #define CUTILS_ANDROID_REBOOT_H
          
          #define ANDROID_RB_RESTART 0xDEAD0001
          #define ANDROID_RB_POWEROFF 0xDEAD0002
          
          #ifdef __cplusplus
          extern "C" {
          #endif
          
          int android_reboot(int cmd);
          
          #ifdef __cplusplus
          }
          #endif
          
          #endif /* CUTILS_ANDROID_REBOOT_H */
          EOF
          
          # 创建临时目录和 cutils 存根文件
          TEMP_DIR=$(mktemp -d)
          cat << 'EOF' > $TEMP_DIR/cutils_stub.c
          #include <cutils/android_reboot.h>
          
          int android_reboot(int cmd) {
              (void)cmd;
              return 0;
          }
          EOF
          
          # 编译 cutils 存根库
          ${{ env.NDK_TOOLCHAIN }}/bin/aarch64-linux-android26-clang \
            -shared -fPIC -Wl,-soname,libcutils.so \
            -I/tmp/android-deps/include \
            -o /tmp/android-deps/lib/libcutils.so \
            $TEMP_DIR/cutils_stub.c
          
          # 创建 cutils pkg-config 文件
          cat << 'EOF' > /tmp/android-deps/lib/pkgconfig/cutils.pc
          prefix=/tmp/android-deps
          exec_prefix=${prefix}
          libdir=${exec_prefix}/lib
          includedir=${prefix}/include
          
          Name: cutils
          Description: Android cutils library
          Version: 1.0.0
          Libs: -L${libdir} -lcutils
          Cflags: -I${includedir}
          EOF
          
          # 创建其他必要的 Android 库存根
          for lib in hardware log sync; do
            cat << EOF > /tmp/android-deps/lib/pkgconfig/$lib.pc
          prefix=/tmp/android-deps
          exec_prefix=\${prefix}
          libdir=\${exec_prefix}/lib
          includedir=\${prefix}/include
          
          Name: $lib
          Description: Android $lib library
          Version: 1.0.0
          Libs:
          Cflags:
          EOF
          done
          
          echo "Android 依赖已构建完成"
          echo "创建的库:"
          ls -la /tmp/android-deps/lib/
          echo ""
          echo "创建的头文件:"
          ls -la /tmp/android-deps/include/

      - name: Build Mesa with PanVk for Android (简化方法)
        run: |
          # 创建 Mesa 交叉编译文件
          cat > build-crossfile << 'EOF'
          [binaries]
          ar = '${{ env.NDK_TOOLCHAIN }}/bin/llvm-ar'
          c = ['${{ env.NDK_TOOLCHAIN }}/bin/aarch64-linux-android26-clang', '-O3', '-DVK_USE_PLATFORM_ANDROID_KHR', '-fPIC']
          cpp = ['${{ env.NDK_TOOLCHAIN }}/bin/aarch64-linux-android26-clang++', '-O3', '-DVK_USE_PLATFORM_ANDROID_KHR', '-fPIC', '-fno-exceptions', '-fno-unwind-tables', '-fno-asynchronous-unwind-tables', '-static-libstdc++']
          c_ld = 'lld'
          cpp_ld = 'lld'
          strip = '${{ env.NDK_TOOLCHAIN }}/bin/llvm-strip'
          pkg-config = ['env', 'PKG_CONFIG_LIBDIR=.:/tmp/android-deps/lib/pkgconfig', '/usr/bin/pkg-config']

          [properties]
          needs_exe_wrapper = true

          [host_machine]
          system = 'linux'
          cpu_family = 'arm'
          cpu = 'armv8'
          endian = 'little'
          EOF

          # 克隆 Mesa - 使用更稳定的版本
          git clone --depth 1 https://gitlab.freedesktop.org/mesa/mesa.git
          cd mesa
          
          # 尝试使用已知能构建 Android 的分支
          git fetch --depth 1 origin mesa-23.3.0
          git checkout mesa-23.3.0
          
          echo "=== 配置 Mesa 构建 ==="
          
          # 创建 minimal 配置，只构建 PanVk
          # 使用更简化的配置，避免复杂的 Android 依赖
          meson setup "build-android" \
            --prefix=/tmp/pan \
            --cross-file "../build-crossfile" \
            --buildtype=release \
            -Dplatforms=android \
            -Dplatform-sdk-version=26 \
            -Dvulkan-drivers=panfrost \
            -Dgallium-drivers= \
            -Ddri-drivers= \
            -Dglx=disabled \
            -Degl=disabled \
            -Dgles1=disabled \
            -Dgles2=disabled \
            -Dopengl=false \
            -Dgbm=disabled \
            -Dshared-glapi=disabled \
            -Dglvnd=false \
            -Dllvm=disabled \
            -Dandroid-stub=true \
            -Dshared-llvm=disabled \
            -Dvalgrind=disabled \
            -Dlibunwind=disabled \
            -Dlmsensors=disabled \
            -Dbuild-tests=false \
            -Dbuild-aco-tests=false

          echo "=== 开始构建 Mesa ==="
          ninja -C "build-android"

      - name: Extract and package PanVk for G610
        run: |
          cd mesa/build-android
          
          echo "=== 检查构建目录 ==="
          find . -name "*.so" -type f 2>/dev/null | head -20 || echo "未找到 .so 文件"
          
          echo ""
          echo "=== 查找所有库文件 ==="
          find . -type f -name "*.so*" 2>/dev/null | while read file; do
            echo "找到: $file"
            file "$file" || true
          done
          
          echo ""
          echo "=== 查找 Vulkan ICD 文件 ==="
          # 查找可能的 Vulkan ICD 文件
          if find . -name "*vulkan*" -type f 2>/dev/null | grep -q .; then
            echo "找到 Vulkan 相关文件:"
            find . -name "*vulkan*" -type f 2>/dev/null
          else
            echo "尝试查找其他 Vulkan 文件..."
            # 检查 src/panfrost/vulkan 目录
            if [ -d "./src/panfrost/vulkan" ]; then
              echo "检查 panfrost/vulkan 目录..."
              find ./src/panfrost/vulkan -type f 2>/dev/null || true
            fi
          fi
          
          # 查找 libvulkan_panfrost.so 或类似文件
          VULKAN_LIB=$(find . -name "*vulkan*panfrost*.so" -o -name "*panfrost*vulkan*.so" 2>/dev/null | head -1)
          
          if [ -n "$VULKAN_LIB" ]; then
            echo "找到 Vulkan 库: $VULKAN_LIB"
            
            # 创建针对 G610 的优化包
            mkdir -p g610-package/system/lib64
            mkdir -p g610-package/system/vendor/lib64/hw
            
            cp "$VULKAN_LIB" g610-package/system/lib64/libvulkan_panfrost.so
            cp "$VULKAN_LIB" g610-package/system/vendor/lib64/hw/vulkan.panfrost.so
            
            echo "=== G610 构建成功! ==="
            echo "库文件列表:"
            ls -la g610-package/system/lib64/
            
            # 创建 G610 专用安装包
            cd g610-package
            tar -czf ../../panvk-g610-$(date +%Y%m%d-%H%M%S).tar.gz system/
          else
            echo "警告: 未找到特定的 Vulkan 库，尝试安装所有构建的文件..."
            
            # 安装到前缀目录
            ninja -C "build-android" install
            
            # 检查安装目录
            if [ -d "/tmp/pan/lib" ]; then
              mkdir -p g610-package/system
              # 复制所有库文件
              find /tmp/pan -name "*.so" -type f 2>/dev/null | while read lib; do
                echo "复制: $lib"
                cp "$lib" g610-package/system/lib64/ 2>/dev/null || true
              done
              
              cd g610-package
              tar -czf ../../panvk-g610-installed-$(date +%Y%m%d-%H%M%S).tar.gz system/
              echo "使用安装目录创建了包"
            else
              echo "错误: 构建可能失败，尝试手动构建..."
              echo "当前目录:"
              pwd
              ls -la
              exit 1
            fi
          fi

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: panvk-g610-build
          path: |
            mesa/panvk-g610-*.tar.gz
            mesa/build-android/g610-package/
          retention-days: 30

      - name: Debug build info
        if: failure()
        run: |
          echo "=== 构建失败，显示调试信息 ==="
          cd mesa/build-android 2>/dev/null || cd mesa
          echo "Meson 日志最后100行:"
          cat meson-logs/meson-log.txt 2>/dev/null | tail -100 || echo "无法读取日志"
          echo ""
          echo "构建目录内容:"
          ls -la 2>/dev/null || echo "无法列出目录"
          echo ""
          echo "配置信息:"
          cat meson-info/intro-buildoptions.txt 2>/dev/null || echo "无法读取配置"
