name: Build PanVk for Mali-G610

on:
  push:
    branches: [main, panvk-android]
  workflow_dispatch:

env:
  NDK_VERSION: 'r25c'
  BUILD_TYPE: 'release'

jobs:
  build-panvk:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout workflow files
      uses: actions/checkout@v4
      
    - name: Setup build environment
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          python3 python3-pip ninja-build pkg-config \
          libdrm-dev libelf-dev gettext bison flex \
          wget unzip git cmake make
        
    - name: Install Meson
      run: |
        pip3 install --upgrade pip
        pip3 install meson mako
        meson --version
        
    - name: Download Android NDK
      run: |
        wget -q https://dl.google.com/android/repository/android-ndk-${{ env.NDK_VERSION }}-linux.zip
        unzip -q android-ndk-${{ env.NDK_VERSION }}-linux.zip
        echo "NDK_HOME=$(pwd)/android-ndk-${{ env.NDK_VERSION }}" >> $GITHUB_ENV
        
    - name: Setup toolchain paths
      run: |
        TOOLCHAIN_DIR="$NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin"
        echo "TOOLCHAIN_DIR=$TOOLCHAIN_DIR" >> $GITHUB_ENV
        
        echo "Toolchain directory: $TOOLCHAIN_DIR"
        ls -la "$TOOLCHAIN_DIR" | grep -E "aarch64|llvm" | head -10
        
        "$TOOLCHAIN_DIR/aarch64-linux-android21-clang" --version || echo "Clang not found"
        
        if [ -f "$TOOLCHAIN_DIR/llvm-ar" ]; then
          echo "Using llvm-ar"
          echo "AR_TOOL=$TOOLCHAIN_DIR/llvm-ar" >> $GITHUB_ENV
          echo "STRIP_TOOL=$TOOLCHAIN_DIR/llvm-strip" >> $GITHUB_ENV
        else
          echo "Using aarch64-linux-android-ar"
          echo "AR_TOOL=$TOOLCHAIN_DIR/aarch64-linux-android-ar" >> $GITHUB_ENV
          echo "STRIP_TOOL=$TOOLCHAIN_DIR/aarch64-linux-android-strip" >> $GITHUB_ENV
        fi
        
    - name: Clone Mesa repository
      run: |
        git clone https://gitlab.freedesktop.org/mesa/mesa.git mesa-src
        cd mesa-src
        git checkout 25.3.0 || git checkout mesa-25.3.0 || git checkout 24.1.0
        
    - name: Configure PanVk build
      run: |
        cd mesa-src
        
        export PATH="$TOOLCHAIN_DIR:$PATH"
        
        # 使用实际路径创建交叉编译文件
        cat > android-cross.txt << EOF
        [binaries]
         c = '$TOOLCHAIN_DIR/aarch64-linux-android21-clang'
        cpp = '$TOOLCHAIN_DIR/aarch64-linux-android21-clang++'
        ar = '$TOOLCHAIN_DIR/llvm-ar'
        strip = '$TOOLCHAIN_DIR/llvm-strip'
        pkg-config = 'pkg-config'

        [host_machine]
        system = 'linux'
        cpu_family = 'aarch64'
        cpu = 'aarch64'
        endian = 'little'
        EOF
        
        echo "Cross file content:"
        cat android-cross.txt
        
        meson setup build-android \
          --cross-file android-cross.txt \
          -Dplatforms=android \
          -Dvulkan-drivers=panfrost \
          -Dgallium-drivers= \
          -Dandroid-stub=true \
          -Dshader-cache=enabled \
          -Dglx=disabled \
          -Degl=disabled \
          -Dgles1=disabled \
          -Dgles2=disabled \
          -Dopengl=false \
          -Dvulkan-beta=true \
          -Dvalgrind=disabled \
          -Dlibunwind=disabled \
          -Dlmsensors=disabled \
          -Dbuildtype=${{ env.BUILD_TYPE }} \
          -Db_ndebug=true \
          -Dcpp_rtti=true \
          -Db_lto=false \
          -Dprefix=/system
        
    - name: Build PanVk driver
      run: |
        cd mesa-src/build-android
        export PATH="$TOOLCHAIN_DIR:$PATH"
        ninja -j$(nproc --all)
        
    - name: Extract and package artifacts
      run: |
        cd mesa-src/build-android
        
        echo "Searching for built libraries..."
        find . -name "*.so" -type f | head -20
        
        mkdir -p output/system/lib64
        
        if [ -f "src/panfrost/vulkan/libvulkan_panfrost.so" ]; then
          cp src/panfrost/vulkan/libvulkan_panfrost.so output/system/lib64/
          echo "Found libvulkan_panfrost.so in standard location"
        elif find . -name "libvulkan_panfrost.so" -type f | head -1; then
          find . -name "libvulkan_panfrost.so" -type f -exec cp {} output/system/lib64/ \;
          echo "Found libvulkan_panfrost.so via search"
        else
          echo "Searching for alternative Vulkan drivers..."
          find src/ -name "*vulkan*.so" -type f -exec cp {} output/system/lib64/ \; 2>/dev/null || true
          find . -path "*/panfrost/*.so" -type f -exec cp {} output/system/lib64/ \; 2>/dev/null || true
        fi
        
        if ls output/system/lib64/*.so >/dev/null 2>&1; then
          echo "Build successful! Found libraries:"
          ls -la output/system/lib64/
          file output/system/lib64/*.so
        else
          echo "Error: No shared libraries found in output directory"
          find . -name "*.so" -type f
          exit 1
        fi
        
        cd output
        tar -czf ../panvk-g610-$(date +%Y%m%d).tar.gz system/
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: panvk-g610-driver
        path: |
          mesa-src/build-android/panvk-g610-*.tar.gz
          mesa-src/build-android/output/system/lib64/*.so
        retention-days: 30
