name: Build PanVk for Mali-G610

on:
  push:
    branches: [ main, panvk-android ]
  workflow_dispatch:
    inputs:
      mesa_version:
        description: 'Mesa version (e.g., 25.3.0, 24.1.0, etc)'
        required: false
        default: '25.3.0'

env:
  NDK_VERSION: 'r25c'
  BUILD_TYPE: 'release'

jobs:
  build-panvk:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout workflow files
      uses: actions/checkout@v4
      
    - name: Setup build environment
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          python3 python3-pip ninja-build pkg-config \
          libdrm-dev libelf-dev gettext bison flex \
          wget unzip git cmake make
        
    - name: Install latest Meson
      run: |
        pip3 install --upgrade pip
        pip3 install meson mako
        meson --version
        
    - name: Download Android NDK
      run: |
        wget -q https://dl.google.com/android/repository/android-ndk-${{ env.NDK_VERSION }}-linux.zip
        unzip -q android-ndk-${{ env.NDK_VERSION }}-linux.zip
        echo "NDK_HOME=$(pwd)/android-ndk-${{ env.NDK_VERSION }}" >> $GITHUB_ENV
        
    - name: Clone and checkout Mesa
      id: mesa_checkout
      run: |
        git clone https://gitlab.freedesktop.org/mesa/mesa.git mesa-src
        cd mesa-src
        
        # 使用手动输入的版本或默认值
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          MESA_VERSION="${{ github.event.inputs.mesa_version }}"
        else
          MESA_VERSION="25.3.0"
        fi
        
        echo "Checking out Mesa version: $MESA_VERSION"
        
        # 直接尝试检出指定版本
        if git checkout "$MESA_VERSION"; then
          echo "Successfully checked out $MESA_VERSION"
          echo "mesa_version=$MESA_VERSION" >> $GITHUB_OUTPUT
        else
          echo "Error: Failed to checkout $MESA_VERSION"
          echo "Available versions:"
          git tag -l | grep -E '^[0-9]' | sort -V | tail -10
          exit 1
        fi
        
    - name: Verify NDK toolchain
      run: |
        echo "Verifying NDK toolchain..."
        export PATH="$NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin:$PATH"
        
        # 检查关键工具
        which aarch64-linux-android21-clang || echo "Clang not found"
        which aarch64-linux-android-ar || echo "AR not found"
        
        aarch64-linux-android21-clang --version || echo "Clang version check failed"
        
    - name: Configure PanVk build
      run: |
        cd mesa-src
        
        # 设置环境变量
        export PATH="$NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin:$PATH"
        
        # 创建交叉编译文件
        cat > android-cross.txt << 'EOF'
        [binaries]
        c = 'aarch64-linux-android21-clang'
        cpp = 'aarch64-linux-android21-clang++'
        ar = 'aarch64-linux-android-ar'
        strip = 'aarch64-linux-android-strip'
        pkgconfig = 'pkg-config'

        [host_machine]
        system = 'linux'
        cpu_family = 'aarch64'
        cpu = 'aarch64'
        endian = 'little'
        EOF
        
        # 配置构建
        meson setup build-android \
          --cross-file android-cross.txt \
          -Dplatforms=android \
          -Dvulkan-drivers=panfrost \
          -Dgallium-drivers= \
          -Dandroid-stub=true \
          -Dshader-cache=enabled \
          -Dglx=disabled \
          -Degl=disabled \
          -Dgles1=disabled \
          -Dgles2=disabled \
          -Dopengl=false \
          -Dosmesa=false \
          -Dshared-glapi=disabled \
          -Dvulkan-beta=true \
          -Dvalgrind=disabled \
          -Dlibunwind=disabled \
          -Dlmsensors=disabled \
          -Dbuildtype=${{ env.BUILD_TYPE }} \
          -Db_ndebug=false \
          -Dcpp_rtti=true \
          -Doptimization=2 \
          -Db_lto=false \
          -Dprefix=/system
        
    - name: Build PanVk driver
      run: |
        cd mesa-src/build-android
        export PATH="$NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin:$PATH"
        ninja -j$(nproc --all)
        
    - name: Extract and verify build output
      run: |
        cd mesa-src/build-android
        
        echo "Build output structure:"
        find . -name "*.so" -type f | head -20
        
        # 创建输出目录
        mkdir -p output/system/lib64
        mkdir -p output/system/vendor/lib64/hw
        
        # 查找并复制PanVk驱动
        if [ -f "src/panfrost/vulkan/libvulkan_panfrost.so" ]; then
          cp src/panfrost/vulkan/libvulkan_panfrost.so output/system/lib64/
          echo "Found libvulkan_panfrost.so in standard location"
        elif find . -path "*/panfrost/vulkan/*.so" -name "libvulkan_panfrost.so" | head -1; then
          find . -path "*/panfrost/vulkan/*.so" -name "libvulkan_panfrost.so" -exec cp {} output/system/lib64/ \;
          echo "Found libvulkan_panfrost.so in panfrost/vulkan directory"
        else
          echo "Searching for any Vulkan-related .so files..."
          find . -name "*vulkan*.so" -type f -exec cp {} output/system/lib64/ \; || true
        fi
        
        # 验证文件
        if ls output/system/lib64/*.so >/dev/null 2>&1; then
          echo "Build successful! Libraries found:"
          ls -la output/system/lib64/
          file output/system/lib64/*.so
        else
          echo "Error: No shared libraries found"
          exit 1
        fi
        
    - name: Create installation packages
      run: |
        cd mesa-src/build-android/output
        
        # 创建Magisk模块
        mkdir -p magisk-module/system/vendor/lib64/hw
        cp system/lib64/*.so magisk-module/system/vendor/lib64/hw/ 2>/dev/null || true
        
        cat > magisk-module/module.prop << EOF
        id=panvk-g610
        name=PanVk for Mali-G610
        version=${{ steps.mesa_checkout.outputs.mesa_version }}-$(date +%Y%m%d)
        versionCode=1
        author=GitHub CI
        description=PanVk Vulkan driver optimized for Mali-G610
        EOF
        
        # 创建安装脚本
        cat > install-panvk.sh << 'EOF'
        #!/system/bin/sh
        echo "Installing PanVk driver for Mali-G610..."
        
        # 检查root权限
        if [ "$(id -u)" -ne 0 ]; then
          echo "Error: This script requires root privileges"
          exit 1
        fi
        
        # 备份原有驱动
        if [ -f "/system/lib64/libvulkan.so" ]; then
          cp /system/lib64/libvulkan.so /system/lib64/libvulkan.so.backup
          echo "Backed up existing Vulkan driver"
        fi
        
        # 安装新驱动
        if [ -f "/sdcard/panvk-g610/libvulkan_panfrost.so" ]; then
          cp /sdcard/panvk-g610/libvulkan_panfrost.so /system/lib64/
          chmod 644 /system/lib64/libvulkan_panfrost.so
          chown root:root /system/lib64/libvulkan_panfrost.so
          echo "PanVk driver installed successfully!"
          echo "Please reboot your device."
        else
          echo "Error: libvulkan_panfrost.so not found in /sdcard/panvk-g610/"
        fi
        EOF
        
        chmod +x install-panvk.sh
        
        # 打包
        tar -czf ../panvk-g610-${{ steps.mesa_checkout.outputs.mesa_version }}-$(date +%Y%m%d).tar.gz system/ install-panvk.sh
        cd magisk-module && zip -r ../panvk-g610-magisk-${{ steps.mesa_checkout.outputs.mesa_version }}-$(date +%Y%m%d).zip ./*
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: panvk-g610-${{ steps.mesa_checkout.outputs.mesa_version }}
        path: |
          mesa-src/build-android/panvk-g610-*.tar.gz
          mesa-src/build-android/panvk-g610-magisk-*.zip
          mesa-src/build-android/output/system/lib64/*.so
        retention-days: 30
        
    - name: Create GitHub Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          mesa-src/build-android/panvk-g610-*.tar.gz
          mesa-src/build-android/panvk-g610-magisk-*.zip
