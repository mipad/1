name: Build PanVk for G610

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup environment
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          python3-pip ninja-build pkg-config \
          libdrm-dev libelf-dev gettext bison flex \
          wget unzip git
        
    - name: Install Meson
      run: pip3 install meson mako
      
    - name: Setup NDK
      run: |
        wget -q https://dl.google.com/android/repository/android-ndk-r25b-linux.zip
        unzip -q android-ndk-r25b-linux.zip
        export NDK_HOME="$(pwd)/android-ndk-r25b"
        echo "NDK_HOME=$NDK_HOME" >> $GITHUB_ENV
        
    - name: Clone and build Mesa
      run: |
        git clone https://gitlab.freedesktop.org/mesa/mesa.git
        cd mesa
        git checkout 24.1.0  # 使用稳定版本
        
        # 创建编译配置
        cat > android-aarch64.ini << 'EOF'
        [binaries]
        c = '$NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android21-clang'
        cpp = '$NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android21-clang++'
        ar = '$NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android-ar'
        strip = '$NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android-strip'

        [host_machine]
        system = 'linux'
        cpu_family = 'aarch64'
        cpu = 'aarch64'
        endian = 'little'
        EOF
        
        # 配置编译
        meson setup build-android \
          --cross-file android-aarch64.ini \
          -Dplatforms=android \
          -Dvulkan-drivers=panfrost \
          -Dgallium-drivers= \
          -Dandroid-stub=true \
          -Dshader-cache=enabled \
          -Dbuildtype=release \
          -Doptimization=3 \
          --prefix=/system
        
        # 编译
        cd build-android
        ninja -j$(nproc)
        
    - name: Package artifacts
      run: |
        cd mesa/build-android
        mkdir -p output/system/lib64
        find . -name "libvulkan_panfrost.so" -exec cp {} output/system/lib64/ \;
        
        # 验证文件
        file output/system/lib64/libvulkan_panfrost.so
        
        # 打包
        tar -czf panvk-g610-$(date +%Y%m%d-%H%M).tar.gz output/
        
    - name: Upload build
      uses: actions/upload-artifact@v4
      with:
        name: panvk-g610-driver
        path: mesa/build-android/panvk-g610-*.tar.gz
